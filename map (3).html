<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta charset="utf-8">
<title>Map</title>
<link rel="stylesheet" type="text/css" href="main.css">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=false"></script>
<script type="text/javascript">
var geocoder;
var map;

function initialize() {
  geocoder = new google.maps.Geocoder();
  var latlng = new google.maps.LatLng(42.3601, 71.0589);
  var mapOptions = {
    zoom: 8,
    center: latlng
  }
  map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
  console.log("geocoder initialized");
}

function codeAddress(address) {
  geocoder.geocode( { 'address': address}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      map.setCenter(results[0].geometry.location);
      var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
      });
    }
  });
}	

$(document).ready(function() {
	initialize();
});
</script>
</head>
<body>

	<div id="map-canvas"></div>
	
	<div id="locationsinfo">
		<p style="font-weight: bold">LOCATIONS</p>
		<div id="locations"></div>
	</div>

	<script type="text/javascript">

	function makeReadable(str) {
		if (str == "U.S.") {
			return "United States";
		}
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	}

	var masterlist = [];
	function getCountriesCities() {
		$.ajax({
			method: 'GET',
			url: 'countries2cities.json',
			dataType: 'json',
			success: function(data) {
				for (var key in data) {
					if (data.hasOwnProperty(key)) {
						masterlist.push(key);
						for (k = 0; k < data[key].length; k++) {
							masterlist.push(data[key][k]);
						}
					}
				}
				InfoFromFeed.getData();
			}
		});
	}

	var InfoFromFeed = (function() {
		function getInfoFromFeed() {
			$.ajax({
				method: 'GET',
				url: 'feed.txt',
				dataType: 'json',
				success: function(data) {
		    	for (i = 0; i < data.posts.length; i++) {
		      	if (data.posts[i].locations.length != 0) {
		        	var ul = document.createElement("ul");
		        	ul.id = i.toString();
		        	$("#locations").append(ul);
			        $("#locations #" + ul.id).append("<li style='font-weight: bold'>" + data.posts[i].title + "</li>");
			        for (j = 0; j < data.posts[i].locations.length; j++) {
			        	if (masterlist.indexOf(makeReadable(data.posts[i].locations[j])) > -1) {
			        		codeAddress(makeReadable(data.posts[i].locations[j]));
		      				$("#locations #" + ul.id).append("<li>" + makeReadable(data.posts[i].locations[j]) + "</li>");
					        if (j == data.posts[i].locations.length - 1) {
					        	$("#locations #" + ul.id).append("<br>");
					        }
			        	}
			        }
		      	}
		      }				
				}
			});
		}
		return {
			getData: function() {
				getInfoFromFeed(function(data){});
			}
		}
	})();

	getCountriesCities();
	
	</script>
</body>
</html>